# Copilot Instructions

- **Platform**: STC8/8051 firmware built with Keil uVision; open `ws2812_driver.uvproj` (or the backup variants) to build/flash. Outputs currently live under `Output/` and `Objects/`; USB CDC/HID static libs are in `Sources/lib`.
- **Encoding guard**: `__ENCODING` is locked to GB2312 in [Sources/inc/config.h#L18](Sources/inc/config.h#L18); keep source files in GB2312-friendly ASCII to avoid toolchain warnings.
- **Clock/printf defaults**: System clock constants are set to 40 MHz in [Sources/inc/config.h#L21-L24](Sources/inc/config.h#L21-L24). `PRINTF_USB` in [Sources/inc/config.h#L26](Sources/inc/config.h#L26) routes `printf` to the USB CDC endpoint provided by the STC USB library.
- **Entry point**: `main` delegates to `SYS_Init` then idles in the main loop with user hook regions at [Sources/main.c#L32-L49](Sources/main.c#L32-L49). Add one-time startup logic in the `MAIN_INITIAL` block and recurring logic in the `MAIN_LOOP` block.
- **System init**: `SYS_Init` configures fast XFR/code/XDATA access, sets all GPIO ports to quasi-bidirectional, inserts a 1 ms settle delay, initializes USB, then enables global interrupts [Sources/main.c#L57-L85](Sources/main.c#L57-L85). If you need alternate pin modes, adjust after the port setup block.
- **Delays**: Busy-wait delay helpers use `MAIN_Fosc` and assume the 40 MHz clock [Sources/main.c#L93-L116](Sources/main.c#L93-L116); keep them short to avoid starving interrupts.
- **USB stack**: `USBLIB_Init` wires STC's USB driver, sets lowest interrupt priority, registers `USBLIB_OUT_Callback`, and configures the ISP keep-alive command [Sources/usblib.c#L32-L42](Sources/usblib.c#L32-L42). Call `USBLIB_WaitConfiged` before exchanging data to ensure the device is enumerated and to feed the watchdog [Sources/usblib.c#L49-L53](Sources/usblib.c#L49-L53).
- **USB RX handling**: The default OUT callback simply echoes host data via `USB_SendData` [Sources/usblib.c#L62-L68](Sources/usblib.c#L62-L68). Replace this section to decode commands or feed the WS2812 driver, but keep the callback registration in `USBLIB_Init` intact.
- **Type and bit macros**: Prefer the common typedefs and register helpers in [Sources/inc/def.h#L6-L167](Sources/inc/def.h#L6-L167) and the per-port macros in [Sources/inc/ai8051u_def.h](Sources/inc/ai8051u_def.h) for GPIO and interrupt configuration instead of ad-hoc literals.
- **AICUBE user blocks**: Generated files contain `//<<AICUBE_USER_*_BEGIN>>` / `END` markers (see [Sources/main.c#L34-L48](Sources/main.c#L34-L48) and [Sources/usblib.c#L39-L69](Sources/usblib.c#L39-L69)). Place custom code inside these to survive regeneration.
- **Project layout**: Core sources live in `Sources/`; `app/`, `driver/`, `hal/`, and `cfg/` are currently empty and available for feature code. Public headers belong in `Sources/inc` so they can be pulled in via `config.h`.
- **External dependencies**: Functions like `usb_init`, `USB_SendData`, and the `DeviceState` symbol come from the STC USB SDK (`ai_usb.h` and the linked libs). Keep their initialization order (init → wait-config → use endpoints) and avoid renaming callbacks expected by the SDK.
- **Common workflow**: 1) Edit user blocks, 2) build the uVision project, 3) flash via STC ISP with USB connected, 4) verify USB enumeration (CDC echo should mirror host data by default). Use the CDC echo path as a quick connectivity test.
- **Adding WS2812 control**: Put LED-driving code in the main loop or USB callback; throttle with `delay_us`/`delay_ms` or timer interrupts rather than long blocking loops. Consider dedicating a GPIO pin after the port-mode setup in `SYS_Init`.
