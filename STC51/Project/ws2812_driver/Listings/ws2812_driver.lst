C251 COMPILER V5.60.0,  ws2812_driver                                                      16/02/26  01:45:12  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE ws2812_driver
OBJECT MODULE PLACED IN .\Objects\ws2812_driver.obj
COMPILER INVOKED BY: D:\Program Files (x86)\Keil_v5\C251\BIN\C251.EXE Sources\fml\ws2812_driver.c XSMALL BROWSE INCDIR(.
                    -\Sources\inc;.\Sources\app;.\Sources\hal;.\Sources\fml;.\Sources\utils;.\Sources;.\Sources\lib) DEBUG PRINT(.\Listings\w
                    -s2812_driver.lst) OBJECT(.\Objects\ws2812_driver.obj) 

stmt  level    source

    1          #include "ws2812_driver.h"
    2          
    3          static sbit WS2812_DI_P10 = P0^3;
    4          static sbit WS2812_DI_P12 = P0^4;
    5          
    6          static uint8_t ws2812_output_pin = WS2812_OUT_P10;
    7          
    8          // WS2812 timing constant
    9          #define WS_RESET_US   100  // latch time >= 80 us
   10          
   11          ////////////////////////////////////////
   12          // 精确延时函数 @ 40MHz
   13          ////////////////////////////////////////
   14          
   15          // 延时约300纳秒
   16          static void Delay300ns(void)
   17          {
   18   1          unsigned long edata i;
   19   1          
   20   1          _nop_();
   21   1          _nop_();
   22   1          _nop_();
   23   1          i = 1UL;
   24   1          while (i) i--;
   25   1      }
   26          
   27          // 延时约600纳秒
   28          static void Delay600ns(void)
   29          {
   30   1          unsigned long edata i;
   31   1          
   32   1          _nop_();
   33   1          _nop_();
   34   1          _nop_();
   35   1          i = 4UL;
   36   1          while (i) i--;
   37   1      }
   38          
   39          static void ws2812_line_high(void)
   40          {
   41   1          if (ws2812_output_pin == WS2812_OUT_P12)
   42   1          {
   43   2              WS2812_DI_P12 = 1;
   44   2          }
   45   1          else
   46   1          {
   47   2              WS2812_DI_P10 = 1;
   48   2          }
   49   1      }
   50          
   51          static void ws2812_line_low(void)
   52          {
   53   1          if (ws2812_output_pin == WS2812_OUT_P12)
   54   1          {
   55   2              WS2812_DI_P12 = 0;
   56   2          }
   57   1          else
C251 COMPILER V5.60.0,  ws2812_driver                                                      16/02/26  01:45:12  PAGE 2   

   58   1          {
   59   2              WS2812_DI_P10 = 0;
   60   2          }
   61   1      }
   62          
   63          void ws2812_init(void)
   64          {
   65   1          P0M1 &= ~(BIT3 | BIT4);
   66   1          P0M0 |= (BIT3 | BIT4);
   67   1      
   68   1          WS2812_DI_P10 = 0;
   69   1          WS2812_DI_P12 = 0;
   70   1          ws2812_output_pin = WS2812_OUT_P10;
   71   1          ws2812_reset_latch();
   72   1      }
   73          
   74          void ws2812_select_output_pin(uint8_t output_pin)
   75          {
   76   1          if (output_pin == WS2812_OUT_P12)
   77   1          {
   78   2              ws2812_output_pin = WS2812_OUT_P12;
   79   2              WS2812_DI_P10 = 0;
   80   2          }
   81   1          else
   82   1          {
   83   2              ws2812_output_pin = WS2812_OUT_P10;
   84   2              WS2812_DI_P12 = 0;
   85   2          }
   86   1      }
   87          
   88          void ws2812_reset_latch(void)
   89          {
   90   1          ws2812_line_low();
   91   1          delay_us(WS_RESET_US);
   92   1      }
   93          
   94          void ws2812_send_bit(uint8_t bit_val)
   95          {
   96   1          if (bit_val)
   97   1          {
   98   2              // T1H: high time for "1" code (~0.6us), T1L: low time (~0.3us)
   99   2              ws2812_line_high();
  100   2              Delay600ns();
  101   2              ws2812_line_low();
  102   2              Delay300ns();
  103   2          }
  104   1          else
  105   1          {
  106   2              // T0H: high time for "0" code (~0.3us), T0L: low time (~0.6us)
  107   2              ws2812_line_high();
  108   2              Delay300ns();
  109   2              ws2812_line_low();
  110   2              Delay600ns();
  111   2          }
  112   1      }
  113          
  114          void ws2812_send_byte(uint8_t value)
  115          {
  116   1          uint8_t mask;
  117   1          for (mask = 0x80; mask != 0; mask >>= 1)
  118   1          {
  119   2              ws2812_send_bit(value & mask);
  120   2          }
  121   1      }
  122          
  123          void ws2812_send_grb(uint8_t g, uint8_t r, uint8_t b)
C251 COMPILER V5.60.0,  ws2812_driver                                                      16/02/26  01:45:12  PAGE 3   

  124          {
  125   1          ws2812_send_byte(g);
  126   1          ws2812_send_byte(r);
  127   1          ws2812_send_byte(b);
  128   1      }
  129          
  130          void ws2812_send_buffer(const uint8_t *grb, uint16_t led_count)
  131          {
  132   1          uint16_t i;
  133   1          uint16_t idx = 0;
  134   1      
  135   1          for (i = 0; i < led_count; i++)
  136   1          {
  137   2              uint8_t g = grb[idx++];
  138   2              uint8_t r = grb[idx++];
  139   2              uint8_t b = grb[idx++];
  140   2              ws2812_send_grb(g, r, b);
  141   2          }
  142   1      
  143   1          ws2812_reset_latch();
  144   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       296     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =         1          9
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =         5     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
