C251 COMPILER V5.60.0,  ws2812_test                                                        16/02/26  01:45:12  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE ws2812_test
OBJECT MODULE PLACED IN .\Objects\ws2812_test.obj
COMPILER INVOKED BY: D:\Program Files (x86)\Keil_v5\C251\BIN\C251.EXE Sources\test\ws2812_test.c XSMALL BROWSE INCDIR(.\
                    -Sources\inc;.\Sources\app;.\Sources\hal;.\Sources\fml;.\Sources\utils;.\Sources;.\Sources\lib) DEBUG PRINT(.\Listings\ws
                    -2812_test.lst) OBJECT(.\Objects\ws2812_test.obj) 

stmt  level    source

    1          #include "ws2812_test.h"
    2          
    3          static sbit HC595_SER = P0^0;
    4          static sbit HC595_RCLK = P0^1;
    5          static sbit HC595_SRCLK = P0^2;
    6          
    7          #define WS_OUT_P10          0
    8          #define WS_OUT_P11          1
    9          
   10          #define TEST_LED_PER_ROW    8
   11          #define TEST_SHIFT_BITS     16
   12          
   13          #define WS2812_PWM_0_DUTY   12
   14          #define WS2812_PWM_1_DUTY   37
   15          #define WS2812_PWM_PERIOD   50
   16          #define WS2812_PWM_NUM      (TEST_LED_PER_ROW * 24 + 2)
   17          
   18          static uint8_t shift_index = 0;
   19          static uint8_t light_count = 1;
   20          static uint8_t ws2812_output_pin = WS_OUT_P10;
   21          static bit ws2812_dma_busy = 0;
   22          
   23          static uint8_t xdata ws_rgb[TEST_LED_PER_ROW][3];
   24          static uint8_t xdata ws_pwm[WS2812_PWM_NUM];
   25          
   26          static void ws2812_apply_output_pin(uint8_t output_pin)
   27          {
   28   1          if (output_pin == WS_OUT_P11)
   29   1          {
   30   2              PWMA_CCER1 = 0x04;
   31   2              PWMA_ENO = 0x02;
   32   2              PWMA_DBA = 0x0D;
   33   2              P10 = 0;
   34   2          }
   35   1          else
   36   1          {
   37   2              PWMA_CCER1 = 0x01;
   38   2              PWMA_ENO = 0x01;
   39   2              PWMA_DBA = 0x0D;
   40   2              P11 = 0;
   41   2          }
   42   1      }
   43          
   44          static void hc595_pulse_srclk(void)
   45          {
   46   1          HC595_SRCLK = 1;
   47   1          _nop_();
   48   1          HC595_SRCLK = 0;
   49   1      }
   50          
   51          static void hc595_pulse_rclk(void)
   52          {
   53   1          HC595_RCLK = 1;
   54   1          _nop_();
   55   1          HC595_RCLK = 0;
   56   1      }
   57          
C251 COMPILER V5.60.0,  ws2812_test                                                        16/02/26  01:45:12  PAGE 2   

   58          static void hc595_write16(uint16_t value)
   59          {
   60   1          int8_t bit_index;
   61   1      
   62   1          for (bit_index = 15; bit_index >= 0; bit_index--)
   63   1          {
   64   2              HC595_SER = (value >> bit_index) & 0x01;
   65   2              hc595_pulse_srclk();
   66   2          }
   67   1      
   68   1          hc595_pulse_rclk();
   69   1      }
   70          
   71          static void ws2812_pwm_config(void)
   72          {
   73   1          PWMA_ENO = 0;
   74   1          PWMA_IER = 0;
   75   1          PWMA_SR1 = 0;
   76   1          PWMA_SR2 = 0;
   77   1      
   78   1          PWMA_PSCRH = 0;
   79   1          PWMA_PSCRL = 0;
   80   1          PWMA_DTR = 24;
   81   1          PWMA_ARRH = 0;
   82   1          PWMA_ARRL = WS2812_PWM_PERIOD - 1;
   83   1      
   84   1          PWMA_CCMR1 = 0x68;
   85   1          PWMA_CCR1H = 0;
   86   1          PWMA_CCR1L = 0;
   87   1      
   88   1          PWMA_CCER1 = 0x01;
   89   1          PWMA_CCER2 = 0x00;
   90   1          PWMA_PS = 0x00;
   91   1          PWMA_ENO = 0x01;
   92   1      
   93   1          P1M1 &= ~(BIT0 | BIT1);
   94   1          P1M0 |= (BIT0 | BIT1);
   95   1      
   96   1          PWMA_BKR = 0x80;
   97   1          PWMA_CR1 = 0x81;
   98   1          PWMA_EGR = 0x01;
   99   1      }
  100          
  101          static void ws2812_build_pwm_data(uint8_t on_count)
  102          {
  103   1          uint8_t led;
  104   1          uint8_t color_idx;
  105   1          uint8_t bit_idx;
  106   1          uint16_t pwm_idx;
  107   1          uint8_t color_val;
  108   1      
  109   1          for (led = 0; led < TEST_LED_PER_ROW; led++)
  110   1          {
  111   2              if (led < on_count)
  112   2              {
  113   3                  ws_rgb[led][0] = 16;
  114   3                  ws_rgb[led][1] = 16;
  115   3                  ws_rgb[led][2] = 16;
  116   3              }
  117   2              else
  118   2              {
  119   3                  ws_rgb[led][0] = 0;
  120   3                  ws_rgb[led][1] = 0;
  121   3                  ws_rgb[led][2] = 0;
  122   3              }
  123   2          }
C251 COMPILER V5.60.0,  ws2812_test                                                        16/02/26  01:45:12  PAGE 3   

  124   1      
  125   1          ws_pwm[0] = 0;
  126   1          pwm_idx = 1;
  127   1          for (led = 0; led < TEST_LED_PER_ROW; led++)
  128   1          {
  129   2              for (color_idx = 0; color_idx < 3; color_idx++)
  130   2              {
  131   3                  color_val = ws_rgb[led][color_idx];
  132   3                  for (bit_idx = 0; bit_idx < 8; bit_idx++)
  133   3                  {
  134   4                      if (color_val & 0x80)
  135   4                      {
  136   5                          ws_pwm[pwm_idx] = WS2812_PWM_1_DUTY;
  137   5                      }
  138   4                      else
  139   4                      {
  140   5                          ws_pwm[pwm_idx] = WS2812_PWM_0_DUTY;
  141   5                      }
  142   4                      color_val <<= 1;
  143   4                      pwm_idx++;
  144   4                  }
  145   3              }
  146   2          }
  147   1          ws_pwm[pwm_idx] = 0;
  148   1      }
  149          
  150          static void ws2812_dma_start(uint8_t xdata *tx_buf, uint16_t num, uint8_t output_pin)
  151          {
  152   1          uint16_t addr;
  153   1      
  154   1          ws2812_apply_output_pin(output_pin);
  155   1      
  156   1          PWMA_DBL = 0x00;
  157   1          PWMA_DER = 0x01;
  158   1          PWMA_DMACR = 0x14;
  159   1      
  160   1          addr = (uint16_t)tx_buf;
  161   1          DMA_PWMAT_TXAH = (uint8_t)(addr >> 8);
  162   1          DMA_PWMAT_TXAL = (uint8_t)addr;
  163   1          DMA_PWMAT_AMTH = (uint8_t)((num - 1) >> 8);
  164   1          DMA_PWMAT_AMT = (uint8_t)(num - 1);
  165   1          DMA_PWMAT_STA = 0x00;
  166   1          DMA_PWMAT_CFG = 0x80;
  167   1          ws2812_dma_busy = 1;
  168   1          DMA_PWMAT_CR = 0xC0;
  169   1      }
  170          
  171          void ws2812_test_init(void)
  172          {
  173   1          P0M1 &= ~(BIT0 | BIT1 | BIT2);
  174   1          P0M0 |= (BIT0 | BIT1 | BIT2);
  175   1      
  176   1          HC595_SER = 0;
  177   1          HC595_RCLK = 0;
  178   1          HC595_SRCLK = 0;
  179   1      
  180   1          ws2812_pwm_config();
  181   1          shift_index = 0;
  182   1          light_count = 1;
  183   1          ws2812_output_pin = WS_OUT_P10;
  184   1          ws2812_dma_busy = 0;
  185   1      }
  186          
  187          void ws2812_test_step(void)
  188          {
  189   1          uint16_t shift_data;
C251 COMPILER V5.60.0,  ws2812_test                                                        16/02/26  01:45:12  PAGE 4   

  190   1      
  191   1          while (ws2812_dma_busy);
  192   1      
  193   1          shift_data = (uint16_t)(~((uint16_t)0x0001 << shift_index));
  194   1          hc595_write16(shift_data);
  195   1      
  196   1          ws2812_build_pwm_data(light_count);
  197   1          ws2812_dma_start(ws_pwm, WS2812_PWM_NUM, ws2812_output_pin);
  198   1          while (ws2812_dma_busy);
  199   1          delay_ms(100);
  200   1      
  201   1          light_count++;
  202   1          if (light_count > TEST_LED_PER_ROW)
  203   1          {
  204   2              light_count = 1;
  205   2              shift_index++;
  206   2      
  207   2              if (shift_index >= TEST_SHIFT_BITS)
  208   2              {
  209   3                  shift_index = 0;
  210   3                  if (ws2812_output_pin == WS_OUT_P10)
  211   3                  {
  212   4                      ws2812_output_pin = WS_OUT_P11;
  213   4                  }
  214   3                  else
  215   3                  {
  216   4                      ws2812_output_pin = WS_OUT_P10;
  217   4                  }
  218   3              }
  219   2          }
  220   1      }
  221          
  222          void PWMAT_DMA_ISR(void) interrupt DMA_PWMAT_VECTOR
  223          {
  224   1          DMA_PWMAT_STA = 0;
  225   1          ws2812_dma_busy = 0;
  226   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       780     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =       218     ------
  xdata-const size     =    ------     ------
  edata size           =         3     ------
  bit size             =         1     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        15     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
